<!DOCTYPE html>
<html lang="ru"
    xmlns:th="https://www.thymeleaf.org"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
    <head>
        <div th:replace="~{fragments/head :: head}"></div>

        <title>Список товаров</title>
    </head>
    <body>
        <!-- Это будут фрагменты thymeleaf -->
        <header>
            <nav th:replace="~{fragments/navbar :: navbar('menu')}"></nav>
        </header>
        <main class="container d-flex flex-column px-0 py-8 main-container-size">
<!--        Объявление форм -->
            <form id="enable-delete-bulk-form" th:action="@{${thisEndpoint}}">
                <input type="hidden" name="page_number" th:value="${currentPage}"/>
                <input type="hidden" name="page_size" th:value="${pageSize}"/>
            </form>
            <form id="delete-bulk-form" th:action="@{${deleteEndpoint}}" method="post" onsubmit="onSubmit()">
                <input type="hidden" name="page_number" th:value="${currentPage}"/>
                <input type="hidden" name="page_size" th:value="${pageSize}"/>
            </form>

            <div class="row justify-content-center m-0">
                <div class="col-auto ms-md-4 mb-7 p-0">
                    <h1 class="m-0">Список товаров</h1>
                </div>
            </div>
<!--        Элементы управления таблицей    -->
            <div
                sec:authorize="hasAuthority('PRODUCT_DELETE')"
                th:if="${(param.delete_products != null) and (param.delete_products[0] == 'true')}"
                class="row justify-content-end mx-0 mb-4"
            >
                <div class="col-md-auto p-0 d-flex justify-content-center">
                    <button
                            class="btn btn-info rounded-custom p-button"
                            form="enable-delete-bulk-form"
                            type="submit"
                    >
                        Отмена
                    </button>
                </div>
                <div class="col-md-auto p-0 mt-4 mt-md-0 d-flex justify-content-center">
                    <button
                            class="btn btn-danger ms-md-3 rounded-custom p-button"
                            form="delete-bulk-form"
                            type="submit"
                    >
                        Удалить товары
                    </button>
                </div>
            </div>
            <div
                    th:unless="${(param.delete_products != null) and (param.delete_products[0] == 'true')}"
                    class="row justify-content-end mx-0 mb-4"
            >
                <div sec:authorize="hasAuthority('PRODUCT_CREATE')" class="col-md-auto p-0 d-flex justify-content-center">
                    <a
                        class="btn btn-primary rounded-custom p-button"
                        th:href="@{${thisEndpoint} + '/new'}"
                    >
                        Добавить товар
                    </a>
                </div>
                <div sec:authorize="hasAuthority('PRODUCT_DELETE')" class="col-md-auto p-0 mt-4 mt-md-0 d-flex justify-content-center">
                    <button
                            class="btn btn-danger ms-md-3 rounded-custom p-button"
                            form="enable-delete-bulk-form"
                            type="submit"
                            name="delete_products" value="true"
                    >
                        Удалить товары
                    </button>
                </div>
            </div>

            <div class="row table-responsive bg-light rounded-4 mx-0 mb-4 p-4">
                <table class="table table-hover">
                    <thead>
                    <tr>
                        <th scope="col">
                            <input th:if="${(param.delete_products != null) and (param.delete_products[0] == 'true')}"
                                class="form-check-input"
                                form="delete-bulk-form"
                                type="checkbox" id="switch-all"
                                onclick="selectAllCheckBoxes()"
                            />
                            <span th:unless="${(param.delete_products != null) and (param.delete_products[0] == 'true')}">#</span>
                        </th>
                        <th scope="col">Название (name)</th>
                        <th scope="col">Описание (description)</th>
                        <div sec:authorize="hasAuthority('PRODUCT_EDIT')">
                            <th scope="col">Редактировать (edit)</th>
                        </div>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="product : ${products}">
                        <td class="align-middle">
                            <input
                                th:if="${(param.delete_products != null) and (param.delete_products[0] == 'true')}"
                                class="form-check-input"
                                form="delete-bulk-form"
                                type="checkbox"
                                name="id" th:value="${product.id}"
                            >
                            <span
                                th:unless="${(param.delete_products != null) and (param.delete_products[0] == 'true')}"
                                th:text="${productStat.count}"
                            ></span>
                        </td>
                        <td class="align-middle" th:text="${product.name}"></td>
                        <td class="align-middle" th:text="${product.description}"></td>
                        <div sec:authorize="hasAuthority('PRODUCT_EDIT')">
                            <td>
                                <form id="edit-product-form" th:action="@{${thisEndpoint} + '/' + ${product.id}}">
                                    <input type="hidden" name="page_number" th:value="${currentPage}"/>
                                    <input type="hidden" name="page_size" th:value="${pageSize}"/>
                                    <button class="update-table-entry border-0 p-0 bg-transparent"
                                        type="submit"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg">
                                            <use
                                                id="edit-icon"
                                                th:href="@{/images/edit.svg} + '#edit'"
                                            />
                                        </svg>
                                    </button>
                                </form>
                            </td>
                        </div>
                    </tr>
                    </tbody>
                </table>
            </div>
<!--        Пагинация   -->
            <div th:if="${totalPages > 1}" class="row justify-content-between align-items-center mt-auto">
                <div th:with="viewedElements=${pageSize * currentPage}"
                     class="col-md-auto ms-md-4 p-0 d-flex justify-content-center"
                >
                    <p>Просмотрено [[${viewedElements}]] из [[${totalElements}]] записей</p>
                </div>
                <div class="col-md-auto mt-4 mt-md-0">
                    <nav aria-label="Pagination">
                        <ul class="custom-pagination bg-light rounded-pill p-pagination m-0 justify-content-center">
                            <li th:unless="${currentPage == 1}" 
                                class="custom-page-item"
                            >
                                <a th:replace="~{fragments/paging :: paging(endpoint=${thisEndpoint}, pageNumber=1, pageSize=${pageSize}, label='<-', tooltip='Перейти на первую страницу', classappend='page-link-size rounded-circle')}"></a>
                            </li>
                            <li th:unless="${currentPage == 1}" 
                                class="custom-page-item"
                            >
                                <a th:replace="~{fragments/paging :: paging(endpoint=${thisEndpoint}, pageNumber=${currentPage - 1}, pageSize=${pageSize}, label='Пред.', tooltip='Перейти на предыдущую страницу', classappend='rounded-pill px-3')}"></a>
                            </li>
                            <li th:if="${currentPage - 1 > 1}" 
                                class="custom-page-item"
                            >
                                <a class="dots text-dark page-link-size d-flex justify-content-center align-items-center ms-n1"
                                   href="#"
                                >
                                    ...
                                </a>
                            </li>
<!--                        В любой момент отображаем не более трех кнопок навигации    -->
                            <li class="custom-page-item"
                                th:classappend="${page == currentPage} ? 'active'"
                                th:each="page : ${#numbers.sequence(currentPage > 1 ? currentPage - 1 : 1, currentPage + 1 < totalPages ? currentPage + 1 : totalPages)}"
                            >
                                <a th:replace="~{fragments/paging :: paging(endpoint=${thisEndpoint}, pageNumber=${page}, pageSize=${pageSize}, label=${page}, tooltip='Перейти на страницу ' + ${page}, classappend='page-link-size rounded-circle mx-1')}"></a>
                            </li>
                            <li th:if="${currentPage + 1 < totalPages}" 
                                class="custom-page-item"
                            >
                                <a class="dots text-dark page-link-size d-flex justify-content-center align-items-center ms-n1"
                                   href="#"
                                >
                                    ...
                                </a>
                            </li>
                            <li th:unless="${currentPage == totalPages}"
                                class="custom-page-item"
                            >
                                <a th:replace="~{fragments/paging :: paging(endpoint=${thisEndpoint}, pageNumber=${currentPage + 1}, pageSize=${pageSize}, label='След.', tooltip='Перейти на следующую страницу', classappend='rounded-pill px-3')}"></a>
                            </li>
                            <li th:unless="${currentPage == totalPages}" 
                                class="custom-page-item"
                            >
                                <a th:replace="~{fragments/paging :: paging(endpoint=${thisEndpoint}, pageNumber=${totalPages}, pageSize=${pageSize}, label='->', tooltip='Перейти на последнюю страницу', classappend='page-link-size rounded-circle')}"></a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </main>
        <footer th:replace="~{fragments/footer :: footer}"></footer>
        <div th:replace="~{fragments/scripts :: scripts}"></div>
    </body>
</html>